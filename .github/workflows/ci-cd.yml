name: CI/CD Pipeline

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  test:
    name: Build test
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - uses: actions/checkout@v5
    
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 10
    
    - name: Setup Node.js
      uses: actions/setup-node@v5
      with:
        node-version: '22'
        cache: 'pnpm'
    
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
    
    - name: Generate Prisma client
      run: pnpm exec prisma generate
    
    - name: Build project
      run: pnpm run build
      
    - name: Type check
      run: pnpm exec tsc --noEmit
      
    - name: Run tests (if exists)
      run: pnpm test --if-present

  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v5
    
    - name: Build Docker image
      run: docker build -t git-plants-backend .
      
    - name: Test Docker image
      run: docker run --rm git-plants-backend echo "Docker build successful"

  migrate:
    name: Deploy & Migrate
    needs: [test, docker]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v5
    
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 10
    
    - name: Setup Node.js
      uses: actions/setup-node@v5
      with:
        node-version: '22'
        cache: 'pnpm'
    
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
    
    - name: Generate Prisma client
      run: pnpm exec prisma generate
    
    - name: Wait for Render deployment
      run: |
        echo "‚è≥ Waiting for Render deployment to complete..."
        sleep 60
    
    - name: Run database migrations and test connections
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
      run: |
        echo "üîç Checking DATABASE_URL..."
        if [ -z "$DATABASE_URL" ]; then
          echo "‚ùå DATABASE_URL is empty!"
          echo "‚ùå Please set DATABASE_URL in GitHub Repository Secrets"
          exit 1
        else
          echo "‚úÖ DATABASE_URL is set (length: ${#DATABASE_URL})"
        fi
        
        echo "üîÑ Running Prisma database migrations..."
        # Automatically resolve any failed migrations
        FAILED_MIGRATION=$(pnpm exec prisma migrate status 2>&1 | grep -oP 'migration \K[^\s]+(?= started .* failed)' | head -1)
        if [ -n "$FAILED_MIGRATION" ]; then
          echo "‚ö†Ô∏è Found failed migration: $FAILED_MIGRATION"
          echo "üîÑ Resolving as rolled-back..."
          pnpm exec prisma migrate resolve --rolled-back "$FAILED_MIGRATION" || true
        fi
        pnpm exec prisma migrate deploy
        echo "‚úÖ Database migrations completed!"
        
        echo "üîç Testing database connectivity..."
        node -e "
          const { PrismaClient } = require('@prisma/client');
          const prisma = new PrismaClient();
          prisma.\$queryRaw\`SELECT 1\`.then(() => {
            console.log('‚úÖ Database connection test passed!');
            prisma.\$disconnect();
          }).catch(err => {
            console.error('‚ùå Database connection test failed:', err.message);
            process.exit(1);
          });
        "
        
        echo "‚ÑπÔ∏è Redis connectivity will be tested on Render server startup"

  notify:
    name: Notification
    needs: [migrate]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: always() && github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Deployment notification
      run: |
        if [ "${{ needs.migrate.result }}" == "success" ]; then
          echo "‚úÖ Deployment successful! All health checks passed."
        else
          echo "‚ö†Ô∏è Deployment completed but some health checks failed."
        fi